# 정적 디스패치와 동적디스패치

메서드 디스패치는 어떤 메서드를 실행해야하는지, 어떤 메서드의 구현을 사용해야하는지 결정하도록 돕는 매커니즘입니다.

- 정적디스패치는 값, 참조타입 모두에서 지원된다.
- 동적디스패치는 상속이 필요한데, 상속은 참조타입만 가능하므로 참조타입에서만 지원된다.

## 정적 디스패치
- 컴파일러가 어떤 구현을 사용하는지 미리 알고있으므로 컴파일 타임에 결정하므로 동적 디스패치보다 빠르다.
- 함수가 호출되면 바로 함수가 위치하는 주소로 점프한다.
- 정적디스패치를 위해서 `final`, `static`키워드를 사용할 수 있다.

## 동적디스패치
- Objective-C는 기본적으로 동적디스패치를 지원한다. 다형성의 형태로 유연성을 제공하기 때문에 대부분의 객체지향언어에서 지원하고 있다.
- 모든 메서드 호출은 witness table(또는 virtual table)을 들여다보고 어떤 메서드를 실행해야 할지 경정한다. 
- 메모리의 오브젝트가 런타임에 결정되므로 이러한 과정을 런타입에 수행한다.
- 비용이 많이 든다.
- `dynamic`, `@objc`키워드를 사용해서 Objective-C 런타임에 메서드를 노출시킨다.

- Table Dispatch
    - 테이블을 사용하는 디스패치 기법이다.
    - 함수 포인터를 가지고 있는 virtual table을 말한다. 특정 메서드의 구현을 찾는데에 사용한다.
        - 모든 서브클래스는 각자의 virtual table을 가지고 있다.
        - 서브 클래스가 메서드를 재정의할 때마다 메서드가 다른 함수 포인터를 가진다.
        - 새롭게 메서드를 재정의할 때마다 virtual table의 배열 끝에 함수 포인터가 저장된다.
        - 컴파일러가 런타임에 테이블을 참조해서 어떤 메서드를 호출할지 결정한다.

- Message Dispatch
    - 가장 동적인 디스패치 방법이다.
    - cocoa framwork, KVO, Core Data 등에서 사용한다.
    - 런타임에 메서드 기능을 바꾸는 method swizzling이 가능하다.
    - Message Dispatch를 사용하기 위해서는 `dynamic`키워드를 사용한다.
    - Swift 4.0 이하 버전에서는 `@objc dynamic`키워드를 자동으로 붙여줬었는데, 이제는 직접 붙여주어야한다.
    - Message Dispatch를 위해서 Objective-C 런타임을 사용하기 때문에 메서드가 디스패치 될때
    클래스의 계층관계를 모두 보고 실행할 메서드를 결정한다.
    - 이러한 작업에 오랜시간이 걸리기 때문에 캐시를 사용하기도 한다.

## 어떤 디스패치인지 판단

- extension에서는 재정의가 불가능하므로 항상 정적 디스패치가 이루어진다.
- 클래스
    - 일반 메서드 선언은 프로토콜과 동일하게 동적디스패치가 적용된다.
    - `@objc dynamic` 키워드를 사용하면 Objective-C 런타임에 노출시켜 메세지 디스패치를 사용한다.
    - `final` 키워드를` 사용하면 서브클래싱이 불가함을 나타내므로 정적디스패치를 사용한다.

##  그럼 메서드 스위즐링이란?
> **배경지식**<br>
Objective_C는 클래스의 메서드를 호출할 때 해당 객체에 메세지를 보내고, 메세지를 받은 객체가 진짜 메서드가 구현되어있는 곳으로 가서 실행된다. 이러한 과정이 런타임에 일어난다.

- Swizzling을 통해서 어떤 메서드를 내가 원하는 메서드로 바꿀 수 있게 된다.
- Swizzling의 단점
    - 스위즐링이 잘 일어나고 있는지 직접 확인해야한다. 컴파일 타임에 알 수 없다.
    - 프레임워크를 사용하고 있다면 이미 스위즐링이 된 메서드를 사용하고 있는지 확인해야한다.
    - 디버깅하기 어렵다.

## final 키워드 왜씀?
1. 클래스가 더이상 상속되지 않는다는 것을 표현하기 위해서
2. 컴파일러에게 상속이 불가능하다는 것을 미리 알려서 성능상의 이점을 얻을 수 있다.
    - 정적디스패치를 사용하므로 컴파일 시점에 어느 메서드를 사용할지 알 수 있게 되므로 성능상의 이점을 가져올 수 있다.
